{% extends "base.html" %}

{% block title %}Gestionar Idiomas{% endblock %}

{% block content %}
    <a href="{{ url_for('panel_guia') }}" style="text-decoration: none; color: #004c3f;">&larr; Volver al Panel</a>
    <h1>Gestión de Idiomas de Trabajo</h1>
    <p>Selecciona los idiomas que manejas y tu nivel de fluidez para cada uno.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="idiomas_form">
        <h2>1. Selecciona tus Idiomas</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; border: 1px solid #ccc; padding: 20px; border-radius: 5px;">
            
            {% for idioma_id, nombre in idiomas_maestros %}
            <div class="language-item" style="display: flex; align-items: center; gap: 10px; width: calc(50% - 20px);">
                
                <input 
                    type="checkbox" 
                    id="idioma_{{ idioma_id }}" 
                    name="idiomas" 
                    value="{{ idioma_id }}"
                    {% if idioma_id in idiomas_actuales %} checked {% endif %}
                    onchange="toggleNivel(this, {{ idioma_id }})"
                >
                <label for="idioma_{{ idioma_id }}" style="font-weight: bold; width: 120px;">{{ nombre }}:</label>

                <select name="nivel_{{ idioma_id }}" id="nivel_{{ idioma_id }}" style="padding: 5px; width: 100px;">
                    <option value="" {% if not idiomas_actuales.get(idioma_id) %} selected {% endif %}>Nivel</option> 
                    <option value="Basico" {% if idiomas_actuales.get(idioma_id) == 'Basico' %} selected {% endif %}>Básico</option>
                    <option value="Intermedio" {% if idiomas_actuales.get(idioma_id) == 'Intermedio' %} selected {% endif %}>Intermedio</option>
                    <option value="Avanzado" {% if idiomas_actuales.get(idioma_id) == 'Avanzado' %} selected {% endif %}>Avanzado</option>
                    <option value="Nativo" {% if idiomas_actuales.get(idioma_id) == 'Nativo' %} selected {% endif %}>Nativo</option>
                </select>

            </div>
            {% endfor %}

        </div>

        <button type="submit" class="btn" style="background-color: #007bff; padding: 10px 30px;">Guardar Idiomas</button>
    </form>

    <hr style="margin-top: 40px;">

    <h2>2. Idiomas Registrados</h2>
    {% if idiomas_actuales %}
        <ul style="list-style-type: none; padding: 0;">
            {% for idioma_id, nivel in idiomas_actuales.items() %}
                {% for id, nombre in idiomas_maestros %}
                    {% if id == idioma_id %}
                        <li style="margin-bottom: 10px; padding: 8px; border-left: 5px solid #004c3f; background-color: #f0f0f0;">
                            <strong>{{ nombre }}</strong>: {{ nivel }}
                        </li>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </ul>
    {% else %}
        <p>Aún no has registrado ningún idioma. Por favor, selecciona los que manejas.</p>
    {% endif %}

<script>
    function toggleNivel(checkbox, idiomaId) {
        const selectElement = document.getElementById('nivel_' + idiomaId);
        
        // Si la casilla está marcada: habilitar y hacer obligatorio.
        if (checkbox.checked) {
            selectElement.setAttribute('required', 'required');
            selectElement.removeAttribute('disabled');
        } else {
            // Si la casilla NO está marcada: deshabilitar y quitar la obligatoriedad.
            selectElement.removeAttribute('required');
            selectElement.setAttribute('disabled', 'disabled');
            selectElement.value = ""; // Opcional: restablecer a "Nivel" (value="")
        }
    }

    // Al cargar la página, inicializar todos los campos
    document.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('input[name="idiomas"]').forEach(checkbox => {
            // Extraer el ID del idioma y llamar a la función para establecer el estado inicial
            const idiomaId = checkbox.id.split('_')[1];
            toggleNivel(checkbox, idiomaId);
        });

        // Añadir evento al formulario para prevenir el envío si hay errores de nivel
        document.getElementById('idiomas_form').addEventListener('submit', function(e) {
            document.querySelectorAll('input[name="idiomas"]').forEach(checkbox => {
                const idiomaId = checkbox.id.split('_')[1];
                const selectElement = document.getElementById('nivel_' + idiomaId);
                
                // Si está marcado Y el valor es vacío ("Nivel"), mostrar error de JS y detener el envío
                if (checkbox.checked && selectElement.value === "") {
                    e.preventDefault(); // Detiene el envío
                    alert(`Debes seleccionar un nivel para el idioma ${checkbox.nextElementSibling.textContent.replace(':', '').trim()}.`);
                    selectElement.focus();
                }
            });
        });
    });
</script>

{% endblock %}
